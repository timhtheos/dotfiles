#!/bin/bash
#
# Github hub prepare-pr-msg
# 
# To execute:
#   git pr
# instead of:
#   git pull-request
#

# Get branch.
branch=$(git symbolic-ref --short HEAD)

# For some reason, we need to make sure that the current branch is pushed.
git push origin $branch

# Convert branch' slashes and dashes to white spaces.
branch=$(echo $branch | sed -e 's/-/ /g' | sed -e 's/\// /g')

# Check if feature branch and has an integer ticket number.
msg=0
ticket=''
if [ $(echo $branch | awk '{print $1}') == 'feature' ] && [[ $(echo $branch | awk '{print $3}') =~ ^-?[0-9]+$ ]]; then
  project=$(echo $branch | awk '{print $2}')
  ticket=$(echo $branch | awk '{print $3}')
  msg=1
fi

# Get branch's project-ticket number.
if [ $msg == 1 ]; then
  ticket="$project-$ticket"
  
  # Generate tmp template file.
  tpl="/tmp/prepare_pr_msg_$(hexdump -n 16 -v -e '/1 "%02X"' /dev/urandom).md"
  touch $tpl

  # Generate tpl contents.
  echo "[$ticket]  " >> $tpl
  echo "" >> $tpl
  echo "## Jira" >> $tpl
  echo "https://prometprojects.atlassian.net/browse/$ticket" >> $tpl
  echo "" >> $tpl
  echo "## Details" >> $tpl
  echo "" >> $tpl
  echo "" >> $tpl
  echo "[//]: # (The first line shall be the PR title.)" >> $tpl
  echo "[//]: # (The succeeding lines shall comprise of the PR description.)" >> $tpl
  echo "[//]: # (All lines that looks like this one shall be ignored, and are comments.)" >> $tpl
  echo "" >> $tpl
  echo "[//]: # (This PR has been created using github/hub.)" >> $tpl
  echo "[//]: # (Template source: https://github.com/timhtheos/dotfiles/blob/master/bin/git-pr)"
  echo "" >> $tpl

  # Edit prepared PR message.
  $(echo $EDITOR) $tpl

  # Execute hub pull-request.
  hub pull-request -F $tpl
fi
