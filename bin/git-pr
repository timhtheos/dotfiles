#!/bin/bash
#
# Github hub prepare-pr-msg
# 
# To execute:
#   git pr
#

# Get branch.
branch=$(git symbolic-ref --short HEAD)

# Convert branch' slashes and dashes to white spaces.
branch=$(echo $branch | sed -e 's/-/ /g' | sed -e 's/\// /g')

# Check if feature branch and has an integer ticket number.
msg=0
ticket=''
if [ $(echo $branch | awk '{print $1}') == 'feature' ] && [[ $(echo $branch | awk '{print $3}') =~ ^-?[0-9]+$ ]]; then
  project=$(echo $branch | awk '{print $2}')
  ticket=$(echo $branch | awk '{print $3}')
  msg=1
fi

# Get branch's project-ticket number.
if [ $msg == 1 ]; then
  ticket="$project-$ticket: "
  
  # Generate tmp template file.
  tpl="~/tmp/prepare_pr_msg_$(hexdump -n 16 -v -e '/1 "%02X"' /dev/urandom).md"
  touch $tpl

  # Generate tpl contents.
  echo "[$ticket]  " >> $tpl
  echo "Jira" >> $tpl
  echo "-----" >> $tpl
  echo "https://prometprojects.atlassian.net/browse/$ticket" >> $tpl
  echo "Detail(s)" >> $tpl
  echo "-----" >> $tpl
  echo "" >> $tpl

  # Edit prepared PR message.
  $(echo $EDITOR) $tpl

  # Execute hub pull-request.
  hub pull-request -F $tpl
fi
